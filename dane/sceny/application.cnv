OBJECT=MOUSE
MOUSE:TYPE=MOUSE
MOUSE:ONCLICK={ /
    @IF(TEXTBOX_BKG^ISVISIBLE(), "_", "TRUE", "TEXTBOX_PROCEED", ""); /
}

OBJECT=CUTSCENE_NAME
CUTSCENE_NAME:TYPE=STRING
CUTSCENE_NAME:VALUE=NULL

#############
#  TEXTBOX  #
#############

OBJECT=TEXTBOX_INTERACTION_BLOCKER
TEXTBOX_INTERACTION_BLOCKER:TYPE=BUTTON
TEXTBOX_INTERACTION_BLOCKER:PRIORITY=899
TEXTBOX_INTERACTION_BLOCKER:RECT=0,0,800,600
TEXTBOX_INTERACTION_BLOCKER:ENABLE=FALSE
TEXTBOX_INTERACTION_BLOCKER:ONCLICKED={ /
    @IF(CUTSCENE_NAME, "!_", "OUTRO", "TEXTBOX_PROCEED", ""); /
}

OBJECT=TEXTBOX_BKG
TEXTBOX_BKG:TYPE=IMAGE
TEXTBOX_BKG:FILENAME=$COMMON\TEXTBOX\TEXTBOX.IMG
TEXTBOX_BKG:VISIBLE=FALSE
TEXTBOX_BKG:TOCANVAS=TRUE
TEXTBOX_BKG:PRIORITY=900
TEXTBOX_BKG:PRELOAD=TRUE
TEXTBOX_BKG:RELEASE=TRUE
TEXTBOX_BKG:MONITORCOLLISION=FALSE
TEXTBOX_BKG:MONITORCOLLISIONALPHA=FALSE

OBJECT=TEXTBOX_AVATAR
TEXTBOX_AVATAR:TYPE=IMAGE
TEXTBOX_AVATAR:FILENAME=$COMMON\TEXTBOX\AVATAR0.IMG
TEXTBOX_AVATAR:VISIBLE=FALSE
TEXTBOX_AVATAR:TOCANVAS=TRUE
TEXTBOX_AVATAR:PRIORITY=920
TEXTBOX_AVATAR:PRELOAD=TRUE
TEXTBOX_AVATAR:RELEASE=TRUE
TEXTBOX_AVATAR:MONITORCOLLISION=FALSE
TEXTBOX_AVATAR:MONITORCOLLISIONALPHA=FALSE
TEXTBOX_AVATAR:ONINIT={LOAD_AVATAR^(0);}

OBJECT=TEXTBOX_FONT
TEXTBOX_FONT:TYPE=FONT
TEXTBOX_FONT:DEF_ARIAL_STANDARD_14=$COMMON\TEXTBOX\ARIAL14.FNT

OBJECT=TEXTBOX_TEXT
TEXTBOX_TEXT:TYPE=TEXT
TEXTBOX_TEXT:VISIBLE=FALSE
TEXTBOX_TEXT:FONT=TEXTBOX_FONT
TEXTBOX_TEXT:TOCANVAS=TRUE
TEXTBOX_TEXT:RECT=126,488,626,570
TEXTBOX_TEXT:PRIORITY=910
TEXTBOX_TEXT:HJUSTIFY=LEFT
TEXTBOX_TEXT:VJUSTIFY=TOP
TEXTBOX_TEXT:MONITORCOLLISION=FALSE
TEXTBOX_TEXT:MONITORCOLLISIONALPHA=FALSE

OBJECT=TEXTBOX_DB_LASTROWNO
TEXTBOX_DB_LASTROWNO:TYPE=INTEGER

OBJECT=LOAD_LINE_TO_SAY
LOAD_LINE_TO_SAY:TYPE=BEHAVIOUR
LOAD_LINE_TO_SAY:CODE={ /
    LINE_TO_SAY^SET(NULL); /
    TEXTBOX_DB^REMOVEALL(); /
    TEXTBOX_DB^LOAD(TEXTBOX_LINE_PATH); /
    @IF(TEXTBOX_DB^GETROWSNO(), ">", 0, "SET_LINE_TO_SAY", ""); /
}

OBJECT=SET_LINE_TO_SAY
SET_LINE_TO_SAY:TYPE=BEHAVIOUR
SET_LINE_TO_SAY:CODE={ /
    TEXTBOX_DB^SELECT(0); /
    TEXTBOX_DB_LASTROWNO^SET(0); /
    PARSE_DB_ROW^RUN(); /
}

OBJECT=SET_NEXT_LINE_TO_SAY
SET_NEXT_LINE_TO_SAY:TYPE=BEHAVIOUR
SET_NEXT_LINE_TO_SAY:CODE={ /
    TEXTBOX_DB^NEXT(); /
    @IF(TEXTBOX_DB^GETCURSORPOS(), ">", TEXTBOX_DB_LASTROWNO^GET(), "{TEXTBOX_DB_LASTROWNO^INC(); PARSE_DB_ROW^RUN();}", ""); /
}

OBJECT=PARSE_DB_ROW
PARSE_DB_ROW:TYPE=BEHAVIOUR
PARSE_DB_ROW:CODE={ /
    TEXTBOX_TMP_LINE^SET("TEXTBOX_DB_CURSOR"); /
    LINE_TO_SAY^SET(TEXTBOX_TMP_LINE|TEXT); /
    LINE_TO_SAY^REPLACE("<br>", "|"); /
    LINE_DURATION^SET(TEXTBOX_TMP_LINE|MSDURATION); /
    LINE_EMPTY_BEH_COUNT^SET(0); /
    LAST_NON_NULL_OPTION^SET(1); /
    LINE_CHOICE_BEH5^SET(TEXTBOX_TMP_LINE|BEHONCHOICE5); @IF(LINE_CHOICE_BEH5, "_", NULL, "{LINE_EMPTY_BEH_COUNT^INC();}", "{TEXTBOX_ENABLE_OPTION^RUN(5); LAST_NON_NULL_OPTION^SET(5);}"); /
    LINE_CHOICE_BEH4^SET(TEXTBOX_TMP_LINE|BEHONCHOICE4); @IF(LINE_CHOICE_BEH4, "_", NULL, "{LINE_EMPTY_BEH_COUNT^INC();}", "{TEXTBOX_ENABLE_OPTION^RUN(4); LAST_NON_NULL_OPTION^SET(4);}"); /
    LINE_CHOICE_BEH3^SET(TEXTBOX_TMP_LINE|BEHONCHOICE3); @IF(LINE_CHOICE_BEH3, "_", NULL, "{LINE_EMPTY_BEH_COUNT^INC();}", "{TEXTBOX_ENABLE_OPTION^RUN(3); LAST_NON_NULL_OPTION^SET(3);}"); /
    LINE_CHOICE_BEH2^SET(TEXTBOX_TMP_LINE|BEHONCHOICE2); @IF(LINE_CHOICE_BEH2, "_", NULL, "{LINE_EMPTY_BEH_COUNT^INC();}", "{TEXTBOX_ENABLE_OPTION^RUN(2); LAST_NON_NULL_OPTION^SET(2);}"); /
    LINE_CHOICE_BEH1^SET(TEXTBOX_TMP_LINE|BEHONCHOICE1); @IF(LINE_CHOICE_BEH1, "_", NULL, "{LINE_EMPTY_BEH_COUNT^INC();}", "{TEXTBOX_ENABLE_OPTION^RUN(1); LAST_NON_NULL_OPTION^SET(1);}"); /
    LINE_CLICKED_LINE^SET(LAST_NON_NULL_OPTION); /
    @IF(LINE_EMPTY_BEH_COUNT, ">", 3, "{TEXTBOX_DISABLE_OPTION^RUNLOOPED(1, 5);}", "{OPTION_SELECTED^SHOW();}"); /
    TEXTBOX_TIMER^SETELAPSE(LINE_DURATION); /
    TEXTBOX_TIMER^SET(0); /
    @IF(LINE_DURATION, ">", 0, "{TEXTBOX_TIMER^ENABLE();}", ""); /
    SHOW_TEXT^RUN(LINE_TO_SAY); /
}

OBJECT=TEXTBOX_DB
TEXTBOX_DB:TYPE=DATABASE
TEXTBOX_DB:MODEL=TEXTBOX_TMP_LINE

OBJECT=TEXTBOX_TMP_LINE
TEXTBOX_TMP_LINE:TYPE=STRUCT
TEXTBOX_TMP_LINE:FIELDS=TEXT<STRING>,MSDURATION<INTEGER>,BEHONCHOICE1<STRING>,BEHONCHOICE2<STRING>,BEHONCHOICE3<STRING>,BEHONCHOICE4<STRING>,BEHONCHOICE5<STRING>

OBJECT=TEXTBOX_TIMER
TEXTBOX_TIMER:TYPE=TIMER
TEXTBOX_TIMER:ENABLED=FALSE
TEXTBOX_TIMER:ELAPSE=0
TEXTBOX_TIMER:TICKS=1
TEXTBOX_TIMER:ONTICK^1=TEXTBOX_PROCEED

OBJECT=TEXTBOX_ENABLE_OPTION_NAME
TEXTBOX_ENABLE_OPTION_NAME:TYPE=STRING

OBJECT=TEXTBOX_ENABLE_OPTION
TEXTBOX_ENABLE_OPTION:TYPE=BEHAVIOUR
TEXTBOX_ENABLE_OPTION:CODE={ /
    TEXTBOX_ENABLE_OPTION_NAME^SET(["BUTTON_OPTION" + $1]); /
    *TEXTBOX_ENABLE_OPTION_NAME^SHOW(); /
    *TEXTBOX_ENABLE_OPTION_NAME^SETASBUTTON(TRUE, TRUE); /
}

OBJECT=TEXTBOX_DISABLE_OPTION_NAME
TEXTBOX_DISABLE_OPTION_NAME:TYPE=STRING

OBJECT=TEXTBOX_DISABLE_OPTION
TEXTBOX_DISABLE_OPTION:TYPE=BEHAVIOUR
TEXTBOX_DISABLE_OPTION:CODE={ /
    TEXTBOX_DISABLE_OPTION_NAME^SET(["BUTTON_OPTION" + $1]); /
    *TEXTBOX_DISABLE_OPTION_NAME^SETASBUTTON(FALSE, FALSE); /
    *TEXTBOX_DISABLE_OPTION_NAME^HIDE(); /
}

OBJECT=TEXTBOX_PROCEED_CHOSEN_BEH
TEXTBOX_PROCEED_CHOSEN_BEH:TYPE=STRING

OBJECT=TEXTBOX_PROCEED
TEXTBOX_PROCEED:TYPE=BEHAVIOUR
TEXTBOX_PROCEED:CODE={ /
    TEXTBOX_TIMER^DISABLE(); /
    OPTION_SELECTED^HIDE(); /
    TEXTBOX_DISABLE_OPTION^RUNLOOPED(1, 5); /
    TEXTBOX_PROCEED_CHOSEN_BEH^SET(["LINE_CHOICE_BEH" + LINE_CLICKED_LINE^GET()]); /
    TEXTBOX_PROCEED_CHOSEN_BEH^SET(*TEXTBOX_PROCEED_CHOSEN_BEH^GET(0, TEXTBOX_PROCEED_CHOSEN_BEH^LENGTH())); /
    HIDE_TEXT^RUN(); /
    SET_NEXT_LINE_TO_SAY^RUN(); /
    @IF(TEXTBOX_PROCEED_CHOSEN_BEH, "!_", "NULL", "{ROUTINE_TO_CALL^SET(TEXTBOX_PROCEED_CHOSEN_BEH);}", ""); /
}

OBJECT=TEXTBOX_BREAK
TEXTBOX_BREAK:TYPE=BEHAVIOUR
TEXTBOX_BREAK:CODE={ /
    TEXTBOX_TIMER^DISABLE(); /
    OPTION_SELECTED^HIDE(); /
    TEXTBOX_DISABLE_OPTION^RUNLOOPED(1, 5); /
    HIDE_TEXT^RUN(); /
}

OBJECT=ROUTINE_TO_CALL
ROUTINE_TO_CALL:TYPE=STRING
ROUTINE_TO_CALL:VALUE=NULL

OBJECT=LINE_TO_SAY
LINE_TO_SAY:TYPE=STRING

OBJECT=LINE_DURATION
LINE_DURATION:TYPE=INTEGER

OBJECT=LINE_CHOICE_BEH1
LINE_CHOICE_BEH1:TYPE=STRING

OBJECT=LINE_CHOICE_BEH2
LINE_CHOICE_BEH2:TYPE=STRING

OBJECT=LINE_CHOICE_BEH3
LINE_CHOICE_BEH3:TYPE=STRING

OBJECT=LINE_CHOICE_BEH4
LINE_CHOICE_BEH4:TYPE=STRING

OBJECT=LINE_CHOICE_BEH5
LINE_CHOICE_BEH5:TYPE=STRING

OBJECT=LINE_EMPTY_BEH_COUNT
LINE_EMPTY_BEH_COUNT:TYPE=INTEGER

OBJECT=LAST_NON_NULL_OPTION
LAST_NON_NULL_OPTION:TYPE=INTEGER

OBJECT=LINE_CLICKED_LINE
LINE_CLICKED_LINE:TYPE=INTEGER
LINE_CLICKED_LINE:VALUE=0
LINE_CLICKED_LINE:ONBRUTALCHANGED={ /
    OPTION_SELECTED^SETPOSITION(122, [LINE_CLICKED_LINE^GET() * 18 + 490 - 18]); /
}

OBJECT=LOAD_AVATAR_ARG
LOAD_AVATAR_ARG:TYPE=STRING
LOAD_AVATAR_ARG:ONCHANGED={ /
    @IF("LOAD_AVATAR_ARG^GET(0)", "_", "$", "{LOAD_AVATAR_ARG^SET(1);}", ""); /
}

OBJECT=LOAD_AVATAR
LOAD_AVATAR:TYPE=BEHAVIOUR
LOAD_AVATAR:CODE={ /
    LOAD_AVATAR_ARG^SET($1); /
    TEXTBOX_AVATAR^LOAD(["$COMMON\TEXTBOX\AVATAR"+LOAD_AVATAR_ARG+".IMG"]); /
    TEXTBOX_AVATAR^SETPOSITION(38, 495); /
}

OBJECT=SHOW_TEXT
SHOW_TEXT:TYPE=BEHAVIOUR
SHOW_TEXT:CODE={ /
    TEXTBOX_TEXT^SETCOLOR(107, 91, 100); /
    TEXTBOX_TEXT^SETTEXT($1); /
    TEXTBOX_INTERACTION_BLOCKER^ENABLE(); /
    TEXTBOX_BKG^SHOW(); /
    TEXTBOX_AVATAR^SHOW(); /
    TEXTBOX_TEXT^SHOW(); /
}

OBJECT=HIDE_TEXT
HIDE_TEXT:TYPE=BEHAVIOUR
HIDE_TEXT:CODE={ /
    TEXTBOX_TEXT^HIDE(); /
    TEXTBOX_AVATAR^HIDE(); /
    TEXTBOX_BKG^HIDE(); /
    TEXTBOX_INTERACTION_BLOCKER^DISABLE(); /
    TEXTBOX_TEXT^SETTEXT(""); /
}

OBJECT=TEXTBOX_SOUND_PATH
TEXTBOX_SOUND_PATH:TYPE=STRING

OBJECT=TEXTBOX_LINE_PATH
TEXTBOX_LINE_PATH:TYPE=STRING

# $1: file name
# $2: avatar index
OBJECT=SAY
SAY:TYPE=BEHAVIOUR
SAY:CODE={ /
    TEXTBOX_LINE_PATH^SET(["$WAVS\"+$1+".TXT"]); /
    LOAD_AVATAR^RUN($2); /
    LOAD_LINE_TO_SAY^RUN(); /
}

OBJECT=OPTION_SELECTED
OPTION_SELECTED:TYPE=IMAGE
OPTION_SELECTED:VISIBLE=FALSE
OPTION_SELECTED:FILENAME=$COMMON\TEXTBOX\SELECTED.IMG
OPTION_SELECTED:TOCANVAS=TRUE
OPTION_SELECTED:PRIORITY=906

OBJECT=BUTTON_OPTION1
BUTTON_OPTION1:TYPE=ANIMO
BUTTON_OPTION1:VISIBLE=FALSE
BUTTON_OPTION1:FILENAME=$COMMON\TEXTBOX\OPTION1.ANN
BUTTON_OPTION1:TOCANVAS=TRUE
BUTTON_OPTION1:PRIORITY=905
BUTTON_OPTION1:ONFOCUSON={LINE_CLICKED_LINE^SET(1);}
BUTTON_OPTION1:ONCLICK={LINE_CLICKED_LINE^SET(1);}

OBJECT=BUTTON_OPTION2
BUTTON_OPTION2:TYPE=ANIMO
BUTTON_OPTION2:VISIBLE=FALSE
BUTTON_OPTION2:FILENAME=$COMMON\TEXTBOX\OPTION2.ANN
BUTTON_OPTION2:TOCANVAS=TRUE
BUTTON_OPTION2:PRIORITY=905
BUTTON_OPTION2:ONFOCUSON={LINE_CLICKED_LINE^SET(2);}
BUTTON_OPTION2:ONCLICK={LINE_CLICKED_LINE^SET(2);}

OBJECT=BUTTON_OPTION3
BUTTON_OPTION3:TYPE=ANIMO
BUTTON_OPTION3:VISIBLE=FALSE
BUTTON_OPTION3:FILENAME=$COMMON\TEXTBOX\OPTION3.ANN
BUTTON_OPTION3:TOCANVAS=TRUE
BUTTON_OPTION3:PRIORITY=905
BUTTON_OPTION3:ONFOCUSON={LINE_CLICKED_LINE^SET(3);}
BUTTON_OPTION3:ONCLICK={LINE_CLICKED_LINE^SET(3);}

OBJECT=BUTTON_OPTION4
BUTTON_OPTION4:TYPE=ANIMO
BUTTON_OPTION4:VISIBLE=FALSE
BUTTON_OPTION4:FILENAME=$COMMON\TEXTBOX\OPTION4.ANN
BUTTON_OPTION4:TOCANVAS=TRUE
BUTTON_OPTION4:PRIORITY=905
BUTTON_OPTION4:ONFOCUSON={LINE_CLICKED_LINE^SET(4);}
BUTTON_OPTION4:ONCLICK={LINE_CLICKED_LINE^SET(4);}

OBJECT=BUTTON_OPTION5
BUTTON_OPTION5:TYPE=ANIMO
BUTTON_OPTION5:VISIBLE=FALSE
BUTTON_OPTION5:FILENAME=$COMMON\TEXTBOX\OPTION5.ANN
BUTTON_OPTION5:TOCANVAS=TRUE
BUTTON_OPTION5:PRIORITY=905
BUTTON_OPTION5:ONFOCUSON={LINE_CLICKED_LINE^SET(5);}
BUTTON_OPTION5:ONCLICK={LINE_CLICKED_LINE^SET(5);}
